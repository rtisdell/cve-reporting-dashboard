import requests
import json
import datetime
import tabulate

#The API can only handle the last 120 days of content, this is to establish the date format for the HTTP request
currentDate = datetime.date.today()
earliestDate = currentDate - datetime.timedelta(days = 1)
print("Hello there! Here is the last day of reported vulnerabilities.")
print(f"Today's date is {currentDate}. 1 day ago, the date was {earliestDate}. Pulling the reports from this time period...")

#pull data from the CVE database
output = requests.get(f"https://services.nvd.nist.gov/rest/json/cves/2.0/?pubStartDate={earliestDate}T00:00:00.000&pubEndDate={currentDate}T00:00:00.000")

#This should probably be a try/catch of some sort but this is the path of least resistence for now. Verify Status 200
if output.status_code == 200:
    print("API returned successfully! Parsing the data...")
else:
    print("API has encountered an error. Please review the code.")
#Convert to JSON
output_dict = output.json()

print(f"This current dataset has {len(output_dict["vulnerabilities"])} entries.")

#Variables for the loop
waiting_count = 0
analyzed_count = 0

#Move through the dictionary and identify the current keys based on NVD Status
for vulnerability in output_dict["vulnerabilities"]:
    cve_data = vulnerability["cve"]
    if cve_data["vulnStatus"] in ["Awaiting Analysis", "Undergoing Analysis"]:
        waiting_count += 1
    elif cve_data["vulnStatus"] == "Analyzed":
        analyzed_count += 1
print(f"There are currently {waiting_count} submissions under analysis. There are currently {analyzed_count} submissions analyzed.")











